(()=>{"use strict";class e{constructor(){this.result=""}addCell(e){'"'==this.result.slice(-1)&&(this.result+=","),e?(e.replace&&(e=e.replace('"','""')),this.result+=`"${e}"`):this.result+='""'}addRow(e){'"'==this.result.slice(-1)&&(this.result+="\n"),e&&e.forEach(e=>{this.addCell(e)})}}class t{constructor(e){this.remaining=e,this.rowNumber=0}readRow(){if(!this.remaining)return void(this.row=void 0);let e=[];for(;this.remaining;){let t=this.remaining.match(/^"(([^"]|"{2})*)"/);if(t)e.push(t[1].replace('""','"')),this.remaining=this.remaining.slice(t[0].length);else{let t=this.remaining.match(/^[^,\r\n]*/);e.push(t[0]),this.remaining=this.remaining.slice(t[0].length)}let s=this.remaining.match(/^[\r\n]+/);if(s){this.remaining=this.remaining.slice(s[0].length);break}this.remaining&&","==this.remaining[0]&&(this.remaining=this.remaining.slice(1),this.remaining||e.push(""))}if(this.row&&this.row.length!=e.length)throw new Error("CSV Parsing Error: Row length is not consistent.");return this.row=e,this.rowNumber++,e}}class s{constructor(){this.qualities={},this.spoofed=!1}static singleInstance=null;static instance(){return this.singleInstance||(this.singleInstance=new s),this.singleInstance}get(e){return this.spoofed?this.spoofedQualities[e]:this.qualities[e]}getAll(){let e=this.qualities;this.spoofed&&(e=this.spoofedQualities);let t=[];for(const s in e)t.push(e[s]);return t}getValue(e,t){return t||(t="level"),this.spoofed?this.spoofedQualities[e]?.[t]??0:this.qualities[e]?.[t]??0}spoof(e){this.spoofed=!0,this.spoofedQualities=e}releaseSpoof(){this.spoofed=!1}onMyself(e){let t={};e.possessions.forEach(e=>{e.possessions.forEach(e=>{t[e.id]=e})}),this.qualities=t}onBranch(e){e.messages?.length>0&&e.messages.forEach(e=>{e.possession&&(this.qualities[e.possession.id]=e.possession)})}onExchange(e){e.possessionsChanged?.length>0&&e.possessionsChanged.forEach(e=>{this.qualities[e.id]=e})}exportToCSV(){let t=this.getAll();const s=new e;return s.addRow(["id","name","level","effectiveLevel","category","nature"]),t.forEach(e=>{s.addRow([e.id,e.name,e.level,e.effectiveLevel,e.category,e.nature])}),s.result}spoofFromCSV(e){const s=new t(e);let n={},i=[],r=0;for(;s.readRow();)if(1==s.rowNumber){for(let e=0;e<s.row.length;e++)i.push(s.row[e]?.trim());if(!i.includes("id"))throw new Error('Does not include an "id" column');if(!i.includes("level"))throw new Error('Does not include a "level" column');if(!i.includes("effectiveLevel"))throw new Error('Does not include a "effectiveLevel" column')}else{let e={};for(let t=0;t<s.row.length;t++)e[i[t]]=s.row[t];n[e.id]=e,r++}return this.spoof(n),r}}class n{static cssRaw='\n        .flq-modal-wrapper {\n            display: none;\n            position: fixed;\n            z-index: 500; /* The mobile footer menu is 450 */\n            left: 0;\n            top: 0;\n            width: 100%;\n            height: 100%;\n            overflow: auto;\n            background-color: rgb(0,0,0); /* Fallback color */\n            background-color: rgba(0,0,0,0.65);\n        }\n\n        .flq-modal-box {\n            margin: 50px auto;\n            padding: 4px;\n            max-width: 600px;\n            background-color: #bdb29e;\n            color: #282520;\n            box-sizing: border-box;\n            font-family: "Roboto Slab",Georgia,Times,serif;\n        }\n\n        .flq-outline {\n            position: relative;\n            margin: 0px;\n            height: 100%;\n            border: 2px solid #897d67;\n            padding: 0px;\n            box-sizing: border-box;\n        }\n\n        .flq-outline  hr {\n            margin: 0px 20px;\n            border: 1px solid #897d67;\n        }\n\n        .flq-title {\n            margin-top: 20px;\n            text-align: center;\n            font-size: 28px;\n            font-weight: bold;\n            user-select: none;\n        }\n\n        .flq-subtitle-links {\n            text-align: center;\n            margin-bottom: 5px;\n            font-size: 12px;\n            user-select: none;\n        }\n\n        .flq-tab-selected\n        {\n            font-weight: bold;\n        }\n\n        .flq-tab-clickable\n        {\n            color: #3f7277;\n        }\n\n        .flq-tab-clickable:hover\n        {\n            color: #254245;\n        }\n\n        .flq-body {\n            margin: 20px;\n        }\n\n        #flq-close {\n            color: black;\n            font-size: 28px;\n            font-weight: bold;\n            display: block;\n            position: absolute;\n            top: 0px;\n            right: 10px;\n        }\n\n        .flq-tab-clickable:hover,\n        .flq-tab-clickable:focus,\n        .flq-cat-titlebar:hover,\n        .flq-cat-titlebar:focus,\n        .flq-quest-main:hover,\n        .flq-quest-main:focus,\n        #flq-close:hover,\n        #flq-close:focus {\n            text-decoration: none;\n            cursor: pointer;\n        }\n\n        @media screen and (max-width: 1000px) {\n            .flq-modal-box {\n                margin: auto;\n                width: 100%;\n                height: 100%;\n            }\n        }\n\n        .flq-cat {\n            margin-bottom: 20px;\n        }\n\n        .flq-cat-titlebar {\n            display: flex;\n            width: 100%;\n            align-items: stretch;\n            user-select: none;\n            background-color: #636363;\n            color: #ffffff;\n            box-shadow: 0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);\n        }\n\n        .flq-cat-title {\n            flex: 1 1 auto;\n            min-width: 0;\n            padding: 5px;\n            font-weight: bold;\n            font-size: 18px;\n        }\n\n        .flq-cat-expand {\n            width: 30px;\n            flex: 0 0 30px;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n        }\n\n        .flq-quest-main {\n            display: flex;\n            width: 100%;\n            align-items: stretch;\n            user-select: none;\n            background-color: #e8dac3;\n            box-shadow: 0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);\n        }\n\n        .flq-quest-status {\n            width: 100px;\n            flex: 0 0 100px;\n            margin: auto;\n        }\n\n        .flq-quest-status div {\n            width: 90px;\n            margin: 5px auto;\n            padding: 5px;\n            text-align: center;\n            border: 1px solid #000000;\n        }\n\n        .flq-quest-toggle {\n            width: 20px;\n            flex: 0 0 20px;\n            text-align: center;\n            margin: auto 0;\n            font-weight: bold;\n        }\n\n        .flq-quest-title {\n            flex: 1 1 auto;\n            min-width: 0;\n            padding: 5px 0;\n            margin: auto 0;\n            font-weight: bold;\n        }\n\n        .flq-hiddenstatus div {\n            visibility: hidden;\n        }\n\n        .flq-inprogress div {\n            background-color: #ddd200;\n            color: #000000;\n        }\n\n        .flq-blocked div {\n            background-color: #636363;\n            color: #ffffff;\n        }\n\n        .flq-completed div {\n            background-color: #2c9c00;\n            color: #ffffff;\n        }\n\n        .flq-quest-details {\n            display: none;\n            background-color: #ffffff;\n            box-shadow: 0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);\n            margin-left: 20px;\n            margin-bottom: 20px;\n        }\n\n        .flq-quest-detail {\n            padding: 5px;\n        }\n\n        .flq-quest-detail-line {\n            border-bottom: 1px solid #808080;\n        }\n\n        .flq-subtask {\n            display: flex;\n            width: 100%;\n            align-items: stretch;\n        }\n\n        .flq-subtask-offsetrow {\n            background-color: #eeeeee;\n        }\n\n        .flq-subtask-description {\n            flex: 1 1 auto;\n            min-width: 0;\n            padding: 5px;\n        }\n\n        .flq-subtask-status {\n            width: 30px;\n            flex: 0 0 30px;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            font-weight: bold;\n            user-select: none;\n            border-left: 1px solid #808080;\n        }\n        \n        #flq-error-title {\n            font-size: 20px;\n            font-weight: bold;\n        }\n\n        #flq-error-trace {\n            font-family: "Lucida Console", "Courier New", monospace;\n            font-size: 8px;\n            margin-left: 5px;\n        }\n\n        .flq-ul {\n            padding-left: 1rem;\n            list-style-type: disc;\n        }\n\n        .flq-ul .flq-ul {\n            list-style-type: circle;\n        }\n\n        .flq-ul .flq-ul .flq-ul {\n            list-style-type: square;\n        }\n        \n        .flq-settings-title {\n            font-size: 1.5em;\n            font-weight: bold;\n        }\n        \n        .flq-settings-group {\n            margin-bottom: 10px;\n        }\n\n        .flq-settings-body {\n            margin-left: 20px;\n        }\n\n        #flq-quest-import-panel {\n            display: none;\n        }\n\n        #flq-quest-import-panel {\n            margin-top: 5px;\n        }\n\n        #flq-qsource-address {\n            width: 100%;\n        }\n\n        #flq-import-state {\n            font-family: "Lucida Console", "Courier New", monospace;\n            border: 1px solid #000;\n            margin-top: 5px;\n            margin-right: 40px;\n            padding: 5px;\n            font-size: 0.9em;\n            white-space: pre-wrap;\n        }\n        ';static insertStylesElement(){let e=document.createElement("style");e.textContent=n.cssRaw,document.head.appendChild(e)}static stylesCheckForDOM(){document.body&&document.head?n.insertStylesElement():requestIdleCallback(n.stylesCheckForDOM)}static injectStyles(){requestIdleCallback(n.stylesCheckForDOM)}}class i{static log(e){console.log(`[FL Quests] ${e}`)}static debug(e){console.log(`[FL Quests] ${e}`)}static error(e){e.stack?console.error(`[FL Quests] ${e.message}\n${e.stack}`):console.error(`[FL Quests] ${e}`)}}class r{static singleInstance;static instance(){return this.singleInstance||(this.singleInstance=new r),this.singleInstance}static SettingKeys=["HideNotStarted","QuestsSourceType","CustomQuestsSource","EnableImportedQuests","ImportedQuests"];getDefaultSettings(){return{HideNotStarted:!1,QuestsSourceType:1}}constructor(){this.restoreSettings(),this.initializeGettersAndSetters()}initializeGettersAndSetters(){r.SettingKeys.forEach(e=>{this[`get${e}`]=function(){return this.get(e)},this[`set${e}`]=function(t){this.set(e,t)}})}storeSettings(){this.settings&&localStorage.setItem("flq-settings",JSON.stringify(this.settings))}restoreSettings(){let e,t=localStorage.getItem("flq-settings");if(t)try{e=JSON.parse(t)}catch(t){i.error(t),e=this.getDefaultSettings()}else e=this.getDefaultSettings();this.applyDefaults(e),this.settings=e}applyDefaults(e){const t=this.getDefaultSettings();for(const s in t)Object.hasOwn(e,s)||(e[s]=t[s])}restoreDefaults(){this.settings=this.getDefaultSettings(),this.storeSettings()}set(e,t){this.settings[e]=t,this.storeSettings()}get(e){return this.settings[e]}getCategoryState(e){return this.get("catstate:"+e)}setCategoryState(e,t){this.set("catstate:"+e,t)}}class a{static Expressions={Header:/^\s*(#{1,6}) /,ListPoint:/^(\s*)([-+]|\* )/};static sanitizeAndFormat(e,t){if(!e)return e;let s=a.htmlEscape(e);if(!t)return s;let n="";return a.mardownSplitChunks(s).forEach(e=>{if(!e.trim())return;let t=a.Expressions.Header.exec(e);if(t){let s=t[1].length,i=e.substring(t[0].length);n+=`<h${s}>${a.formatTextChunk(i)}</h${s}>`}else e.match(a.Expressions.ListPoint)?n+=a.handleListChunk(e):n+="<p>"+a.formatTextChunk(e)+"</p>"}),n}static mardownSplitChunks(e){if(!e)return[];let t=e.split("\r\n"),s=[];t.forEach(e=>{e.split("\n").forEach(e=>{s.push(e)})});let n,i=[];for(const e in s)s[e]?n?n+="\n"+s[e]:n=s[e]:n&&(i.push(n),n=null),e==s.length-1&&n&&i.push(n);return i}static handleListChunk(e){let t=e.split("\n"),s=[];return t.forEach(e=>{let t=a.Expressions.ListPoint.exec(e);if(t)s.push({depth:t[1].length+3*(t[1].match(/\t/g)?.length??0),chunk:e.substring(t[0].length)});else{if(0==s.length)throw new Error("Cannot listify non-list chunk.");s[s.length-1].chunk+="\n"+e}}),a.collapsePoints(s)}static collapsePoints(e){let t=e.map(e=>e.depth),s=Math.min.apply(Math,t),n=[],i=[];for(let t=0;t<e.length;t++){let r=e[t];r.depth>s&&n.push(r),t!=e.length-1&&r.depth!=s||n.length>0&&(i.push(a.collapsePoints(n)),n=[]),r.depth==s&&i.push(`<li class="flq-li">${a.formatTextChunk(r.chunk)}</li>`)}return`<ul class="flq-ul">${i.join("")}</ul>`}static formatTextChunk(e){if(!e)return e;let t=e.split("\n"),s="";return t.forEach(e=>{let t=e.trim();s&&(s+=" "),s+=a.markdownCharacterEmphasis(t)}),s}static markdownCharacterEmphasis(e){const t=[/\*{3}([^\*\s]([^\*]|(?<![^\*\s]\*\*)\*)*)(?<=[^\*])\*{3}/,/\*{2}([^\*\s]([^\*]|(?<![^\*\s]\*)\*)*)(?<=[^\*])\*{2}/,/\*([^\*\s]([^\*]|(?<![^\s\*])\*)*)(?<=[^\*])\*/,/~{2}([^~\s]([^~]|(?<![^~\s]~)~)*)(?<=[^~])~{2}/];let s="",n=e;for(;n;){let e,i;for(let s=0;s<t.length;s++){let r=t[s].exec(n);r&&(!e||r.index<e.index)&&(e=r,i=s)}if(e){let t=this.markdownCharacterEmphasis(e[1]);switch(s+=n.substring(0,e.index),n=n.substring(e.index+e[0].length),i){case 0:s+="<b><i>"+t+"</i></b>";break;case 1:s+="<b>"+t+"</b>";break;case 2:s+="<i>"+t+"</i>";break;case 3:s+="<s>"+t+"</s>";break;default:throw new Error("Markdown emphasis type not implemented")}}else s+=n,n=""}return s}static htmlEscape(e){return e.replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/>/g,"&gt;").replace(/</g,"&lt;")}}class o{static CharacterCodes={TriangleUp:"&#9650;",TriangleDown:"&#9660;",Checkmark:"&#10003;"};constructor(){this.settings=r.instance()}makeElement(e,t,s){let n=document.createElement(e);return n.className=t,s&&s.forEach(e=>{n.appendChild(e)}),n}makeElementWithInnerHtml(e,t,s){let n=document.createElement(e);return n.className=t,n.innerHTML=s,n}makeTextElement(e,t,s,n){return this.makeElementWithInnerHtml(e,t,a.sanitizeAndFormat(s,n))}makeQuestElement(e){let t;switch(e.state){case 1:t=this.makeElementWithInnerHtml("div","flq-quest-status flq-notstarted","<div>Not Started</div>");break;case 5:t=this.makeElementWithInnerHtml("div","flq-quest-status flq-hiddenstatus","<div>Hidden</div>");break;case 2:t=this.makeElementWithInnerHtml("div","flq-quest-status flq-inprogress","<div>In Progress</div>");break;case 3:t=this.makeElementWithInnerHtml("div","flq-quest-status flq-blocked","<div>Blocked</div>");break;case 4:t=this.makeElementWithInnerHtml("div","flq-quest-status flq-completed","<div>Completed</div>");break;default:t=this.makeElementWithInnerHtml("div","flq-quest-status","<div>ERROR</div>")}let s=this.makeElementWithInnerHtml("div","flq-quest-toggle","+"),n=this.makeElement("div","flq-quest-main",[s,this.makeTextElement("div","flq-quest-title",e.title,!1),t]),i=[],r=this.makeTextElement("div","flq-quest-detail",e.details,!0);e.subtasks?.length>0&&r.classList.add("flq-quest-detail-line"),i.push(r);let a=0;e.subtasks&&e.subtasks.forEach(e=>{let t;t=e.completed?this.makeElementWithInnerHtml("div","flq-subtask-status",o.CharacterCodes.Checkmark):this.makeElementWithInnerHtml("div","flq-subtask-status","");let s=this.makeElement("div","flq-subtask",[this.makeTextElement("div","flq-subtask-description",e.description,!0),t]);a%2==1&&s.classList.add("flq-subtask-offsetrow"),a++,i.push(s)});let l=this.makeElement("div","flq-quest-details",i);return n.onclick=function(){l.style.display&&"none"!=l.style.display?(l.style.display="none",s.textContent="+"):(l.style.display="block",s.textContent="-")},this.makeElement("div","flq-quest",[n,l])}makeCategoryElement(e,t){let s=[],n=0,i=this.settings.getHideNotStarted();e.quests.forEach(e=>{(!i||1!=e.state&&5!=e.state)&&(s.push(this.makeQuestElement(e)),4==e.state&&n++)});let a=this.makeTextElement("div","flq-cat-title",`${e.title} (${n}/${e.quests.length})`,!1),l=this.makeElementWithInnerHtml("div","flq-cat-expand",o.CharacterCodes.TriangleUp),u=this.makeElement("div","flq-cat-titlebar",[a,l]),d=this.makeElement("div","flq-cat-quests",s);return t&&(d.style.display="none",l.innerHTML=o.CharacterCodes.TriangleDown),u.onclick=function(){"none"!=d.style.display?(d.style.display="none",l.innerHTML=o.CharacterCodes.TriangleDown,r.instance().setCategoryState(e.id,ModalManager.CategoryState.Collapsed)):(d.style.display="block",l.innerHTML=o.CharacterCodes.TriangleUp,r.instance().setCategoryState(e.id,ModalManager.CategoryState.Show))},this.makeElement("div","flq-cat",[u,d])}}class l{validate(e,t){if(!e)return this.makeResult(!1,"Input was undefined");let s;if(!t&&(s=this.isValidStringProperty(e.version),!s.valid))return this.makeResult(!1,"Version Property Error: "+s.reason);if(s=this.isValidArray(e.categories,!0),!s.valid)return this.makeResult(!1,"Category List Error: "+s.reason);for(const t in e.categories){let s=this.validateCategory(e.categories[t]);if(!s.valid)return s}let n=[];for(const t in e.categories){if(n.indexOf(e.categories[t].id)>=0)return this.makeResult(!1,"Category ID Not Unique: "+e.categories[t].id);n.push(e.categories[t].id)}return this.makeResult(!0)}validateCategory(e){let t;if(t=this.isValidIDProperty(e.id),!t.valid)return this.makeResult(!1,"Category ID Error: "+t.reason);if(t=this.isValidStringProperty(e.title),!t.valid)return this.makeResult(!1,"Category Title Error: "+t.reason);if(t=this.isValidInteger(e.order),!t.valid)return this.makeResult(!1,"Category Order Error: "+t.reason);if(t=this.isValidArray(e.quests,!0),!t.valid)return this.makeResult(!1,"Category Quest List Error: "+t.reason);for(const s in e.quests)if(t=this.validateQuest(e.quests[s]),!t.valid)return t;return this.makeResult(!0)}validateQuest(e){let t;if(t=this.isValidStringProperty(e.title),!t.valid)return this.makeResult(!1,"Quest Title Error: "+t.reason);if(t=this.isValidInteger(e.order),!t.valid)return this.makeResult(!1,"Quest Order Error: "+t.reason);if(t=this.isValidArray(e.states,!0),!t.valid)return this.makeResult(!1,"Quest States Error: "+t.reason);for(const s in e.states)if(t=this.validateState(e.states[s]),!t.valid)return t;return this.makeResult(!0)}validateState(e){let t;if(t=this.isValidInteger(e.state,1,5),!t.valid)return this.makeResult(!1,"Quest State Type Error: "+t.reason);if(t=this.isValidStringProperty(e.description),!t.valid)return this.makeResult(!1,"Quest State Description Error: "+t.reason);if(t=this.validateCondition(e.condition),!t.valid)return this.makeResult(!1,"Quest State Condition Error: "+t.reason);if(e.tasks){if(t=this.isValidArray(e.tasks),!t.valid)return this.makeResult(!1,"Quest State Tasks Error: "+t.reason);for(const s in e.tasks)if(t=this.validateTask(e.tasks[s]),!t.valid)return t}return this.makeResult(!0)}validateTask(e){let t;return t=this.isValidStringProperty(e.description),t.valid?(t=this.validateCondition(e.completed),t.valid?e.visible&&(t=this.validateCondition(e.visible),!t.valid)?this.makeResult(!1,"Task Visible Error: "+t.reason):this.makeResult(!0):this.makeResult(!1,"Task Completed Error: "+t.reason)):this.makeResult(!1,"Task Description Error: "+t.reason)}validateCondition(e){let t;if(!e)return this.makeResult(!1,"Condition undefined");if(t=this.isValidInteger(e.type,1,4),!t.valid)return this.makeResult(!1,"Condition Type Error: "+t.reason);switch(e.type){case 2:case 3:return t=this.validateCondition(e.left),t.valid?(t=this.validateCondition(e.right),t.valid?this.makeResult(!0):t):t;case 4:return this.validateCondition(e.statement);case 1:if(t=this.isValidInteger(e.quality),!t.valid)return this.makeResult(!1,"Condition Quality Error: "+t.reason);if(e.property){if(t=this.isValidStringProperty(e.property),!t.valid)return this.makeResult(!1,"Condition Property Error: "+t.reason);if(!AllowedQualityProperties.includes(t.property))return this.makeResult(!1,`Condition Property Error: Unknown quality property "${t.property}"`)}return t=this.isValidInteger(e.value),t.valid?(t=this.isValidInteger(e.comparison,1,6),t.valid?this.makeResult(!0):this.makeResult(!1,"Condition Comparison Error: "+t.reason)):this.makeResult(!1,"Condition Value Error: "+t.reason);default:return this.makeResult(!1,"No handling defined for condition type")}}isValidStringProperty(e){return e?this.isString(e)?this.makeResult(!0):this.makeResult(!1,"Not a string"):this.makeResult(!1,"Undefined")}isValidIDProperty(e){let t=this.isValidStringProperty(e);return t.isValid?/^\w{1,500}$/.test(e)?void 0:this.makeResult(!1,"IDs must contain only letters, numbers, and underscores and be fewer than 500 characters."):t}isValidArray(e,t){return e?Array.isArray(e)?t&&0==e.length?this.makeResult(!1,"Is Empty"):this.makeResult(!0):this.makeResult(!1,"Not an Array"):this.makeResult(!1,"Undefined")}isValidInteger(e,t,s){return Number.isInteger(e)?t&&s&&(e<t||e>s)?this.makeResult(!1,"Invalid value"):this.makeResult(!0):this.makeResult(!1,"Is not an Integer")}isString(e){return"string"==typeof e||e instanceof String}makeResult(e,t){let s={valid:e};return t&&(s.reason=t),s}}class u{constructor(){this.qualities=s.instance(),this.settings=r.instance(),this.validator=new l,this.getQuests()}clear(){this.quests=null,this.questsRaw=null}clearImported(){this.quests=null}async getQuests(){if(this.quests)return this.quests;for(;this.fetching;)if(await new Promise(e=>setTimeout(e,10)),this.quests)return this.quests;try{this.fetching=!0;let e=await this.fetchQuestsFromSource();e||(e={version:"No Source Quests",categories:[]});let t=this.getImportedQuests();return this.quests=this.resolveQuests(e,t),this.quests}finally{this.fetching=!1}}getQuestsSource(){let e;switch(this.settings.getQuestsSourceType()){case 1:e=chrome.runtime.getURL("quests/quests.json");break;case 2:throw new Error("NOT IMPLEMENTED");case 3:e=this.settings.getCustomQuestsSource();break;default:e=""}return e}async fetchQuestsFromSource(){if(this.questsRaw)return JSON.parse(this.questsRaw);for(;this.fetchingRaw;)if(await new Promise(e=>setTimeout(e,10)),this.questsRaw)return JSON.parse(this.questsRaw);try{i.log("Fetching quests from source."),this.fetchingRaw=!0;let e=this.getQuestsSource();if(!e)return void i.log("No quests source specified");i.log(`Quests Source: ${e}`);let t=await fetch(e);if(!t.ok)throw new Error("HTTP error: "+t.status);let s=await t.json(),n=this.validator.validate(s);if(!n.valid)throw new Error("Quests Validation Failed: "+n.reason);return i.log(`Source Quests Version: ${s.version}`),i.log(`Fetched ${s.categories.length} Quest Categories From Source`),this.questsRaw=JSON.stringify(s),JSON.parse(this.questsRaw)}finally{this.fetchingRaw=!1}}getImportedQuests(){try{if(!this.settings.getEnableImportedQuests())return;let e=this.settings.getImportedQuests();if(!e)return;let t=JSON.parse(e),s=this.validator.validate(t,!0);return s.valid?t:void i.error("Imported Quests Invalid: "+s.reason)}catch(e){i.error(e)}}resolveQuests(e,t){t&&t.categories.forEach(t=>{t.isImport=!0;let s=e.categories.findIndex(e=>e.id==t.id);s>=0?(i.log(`Overwrote Category: ${t.id} (${e.categories[s].title} -> ${t.title})`),t.isOverride=!0,t.originalTitle=e.categories[s].title,e.categories[s]=t):(i.log(`Imported Category: ${t.id} (${t.title})`),e.categories.push(t))});const s=function(e,t){return t.order-e.order};return e.categories.sort(s),e.categories.forEach(e=>{e.quests.sort(s)}),e}async getCategories(){return(await this.getQuests()).categories}async renderQuests(){let e=await this.getCategories(),t=[];return e.forEach(e=>{if(!e.quests)return;let s={id:e.id,title:e.title,quests:[]};e.quests.forEach(e=>{let t=this.renderQuest(e);t&&s.quests.push(t)}),s.quests.length>0&&t.push(s)}),t}renderQuest(e){if(!e.title)throw new Error("Quest does not define a title.");if(!e.states||0==e.states.length)throw new Error("Quest does not define any states.");let t,s={title:e.title,subtasks:[]};for(let s=e.states.length-1;s>=0&&(t=e.states[s],!this.evaluateCondition(t.condition));s--);return t?(s.state=t.state,s.details=t.description,t.tasks&&t.tasks.forEach(e=>{if(!e.description)throw new Error("Sub task does not include a description condition.");if(!e.completed)throw new Error("Sub task does not include a completed condition.");e.visible&&!this.evaluateCondition(e.visible)||s.subtasks.push({description:e.description,completed:this.evaluateCondition(e.completed)})}),s):null}evaluateCondition(e){switch(e.type){case 2:return this.evaluateCondition(e.left)&&this.evaluateCondition(e.right);case 3:return this.evaluateCondition(e.left)||this.evaluateCondition(e.right);case 4:return!this.evaluateCondition(e.statement);case 1:return this.evaluateComparison(e);default:throw new Error("Unknown condition type: "+e.type)}}evaluateComparison(e){if(!e.quality)throw new Error("Quality comparision does not specify a quality.");if(!Object.hasOwn(e,"value"))throw new Error("Quality comparision does not specify a value.");let t=this.qualities.getValue(e.quality,e.property);switch(e.comparison){case 1:return t==e.value;case 2:return t!=e.value;case 3:return t>e.value;case 4:return t>=e.value;case 5:return t<e.value;case 6:return t<=e.value;default:throw new Error("Unknown comparison type: "+e.comparison)}}}class d{constructor(e){this.value=e,this.index=0}next(){if(this.index>=this.value.length)this.last=null;else{if(this.isWhiteSpace(this.value[this.index])&&this.moveNextNot(this.isWhiteSpace),!(this.index>=this.value.length))return this.lastIndex=this.index,this.isLogicChar(this.value[this.index])?this.moveNextNot(this.isLogicChar):this.isComparison(this.value[this.index])?this.moveNextNot(this.isComparison):this.isLetter(this.value[this.index])?this.moveNextNot(this.isLetter):this.isNumber(this.value[this.index])?this.moveNextNot(this.isNumber):this.index++,this.last=this.value.substring(this.lastIndex,this.index),this.last;this.last=null}}nextThrowIfEnd(){let e=this.next();if(!e)throw new Error("Unexpected end of condition");return e}moveNextNot(e){for(;this.index<this.value.length&&e(this.value[this.index]);)this.index++}isLogicChar(e){return/^[|&]$/.test(e)}isComparison(e){return/^[!=<>]$/.test(e)}isLetter(e){return/^[a-zA-Z]$/.test(e)}isNumber(e){return/^[0-9]$/.test(e)}isWhiteSpace(e){return/^\s$/.test(e)}}class c extends Error{constructor(e,t){super(`Condition error at position ${e}: ${t}`),this.position=e}}class h{parse(e,t){try{let s=new d(e);return s.next(),this.parseStatement(s,t)}catch(e){return{error:e.message}}}parseStatement(e,t,s,n){let i=e.last;if(!i)return s;if(")"==i&&n)return s;let r,a=this.getLogicType(i);if(a){if(!s)throw new c(e.lastIndex,"No left hand side to logic statement.");e.nextThrowIfEnd();let i={type:a,left:s,right:this.parseStatement(e,t,null,n)};return this.parseStatement(e,t,i,n)}if(s)throw new c(e.lastIndex,`Unexpected element '${i}'`);if("!"==i){e.nextThrowIfEnd();let s=this.parseStatement(e,t,null,n);if(!s)throw new c(e.lastIndex,"No statement following a NOT.");r={type:4,statement:s}}else if("("==i){let s=e.lastIndex;if(e.nextThrowIfEnd(),r=this.parseStatement(e,t,null,(n??0)+1),")"!=e.last)throw new c(s,"Bracket not closed.");e.next()}else{if(!this.isLetterString(i))throw new c(e.lastIndex,`Unknown element '${i}'`);r=this.parseComparision(i,e,t)}return this.parseStatement(e,t,r,n)}parseComparision(e,t,s){let n=s[e];if(!n)throw new c(t.lastIndex,`No mapping for '${e}'`);let i={type:1,quality:n,comparison:3,value:0},r=t.next();if("."==r){if(r=t.nextThrowIfEnd(),!this.isLetterString(r))throw new c(t.lastIndex,`Invalid quality property '${r}'`);if(!AllowedQualityProperties.includes(r))throw new c(t.lastIndex,`Unknown quality property '${r}'`);i.property=r,r=t.next()}let a=this.getComparisonType(r);if(a){if(i.comparison=a,r=t.nextThrowIfEnd(),!this.isNumberString(r))throw new c(t.lastIndex,`Comparision value '${r}' is not number.`);i.value=parseInt(r),r=t.next()}return i}getLogicType(e){switch(e){case"&":case"&&":return 2;case"|":case"||":return 3;default:return 0}}getComparisonType(e){switch(e){case"=":case"==":return 1;case"!=":return 2;case">":return 3;case">=":return 4;case"<":return 5;case"<=":return 6;default:return 0}}isLetterString(e){return/^[a-zA-Z]+$/.test(e)}isNumberString(e){return/^[0-9]+$/.test(e)}}class m{constructor(){this.conditionParser=new h}parse(e){let s=new t(e),n={rowNumber:0,categories:[],currentCategory:null,currentQuest:null,currentQuestState:null,mappings:{}};for(;s.readRow();){let e=s.row;if(e.length<4)return{row:s.rowNumber,column:0,error:"CSV includes fewer than 4 columns"};i.debug(`Parsing row ${s.rowNumber}`),n.rowNumber=s.rowNumber;let t=e[0]?.trim()?.toLowerCase()??"";if(!t.startsWith("//"))if("category"==t){i.debug("Parsing Category");let t=this.parseCategoryRow(e,n);if(t?.error)return t}else if("mappings"==t){i.debug("Parsing Mappings");let t=this.parseMappingsRow(e,n);if(t?.error)return t}else if("quest"==t){i.debug("Parsing Quest");let t=this.parseQuestRow(e,n);if(t?.error)return t}else if(this.isIntegerString(t)){i.debug("Parsing Quest State");let t=this.parseQuestStateRow(e,n);if(t?.error)return t}else{if(t)return{row:s.rowNumber,column:0,error:"Unexpected value"};{i.debug("Parsing Task");let t=this.parseTaskRow(e,n);if(t?.error)return t}}}let r=this.requireClosed(n,!0,!0);return r.error?r:{categories:n.categories}}isIntegerString(e){return/^\d+$/.test(e)}isValidIDString(e){return/^\w{1,500}$/.test(e)}parseCategoryRow(e,t){let s=this.requireClosed(t,!0,!0);if(s.error)return s;this.undeclare(t,!0,!0,!0);let n=e[2]?.trim()??"";if(!this.isValidIDString(n))return{row:t.rowNumber,column:2,error:"Category ID is not a valid ID string. ID strings include only letters, numbers, and underscores and have a maximum length of 500 characters."};let i=e[3]?.trim()??"";if(!this.isIntegerString(i))return{row:t.rowNumber,column:3,error:"Category order is not a valid integer."};let r=parseInt(i);if(!e[1]?.trim())return{row:t.rowNumber,column:1,error:"Category title is empty."};let a={id:n,title:e[1].trim(),order:r,quests:[]};t.categories.push(a),t.currentCategory=a}parseMappingsRow(e,t){let s=e[1]?.match(/[a-zA-Z]+=\d+/g);if(!s)return{row:t.rowNumber,column:1,error:"No mappings found"};s.forEach(e=>{let s=e.split("=");t.mappings[s[0]]=parseInt(s[1])})}parseQuestRow(e,t){let s=this.requireDeclared(t,!0);if(s.error)return s;if(s=this.requireClosed(t,!1,!0),s.error)return s;this.undeclare(t,!1,!0,!0);let n=e[2]?.trim()??"";if(!this.isIntegerString(n))return{row:t.rowNumber,column:2,error:"Quest order is not a valid integer."};let i=parseInt(n);if(!e[1]?.trim())return{row:t.rowNumber,column:1,error:"Quest title is empty."};let r={title:e[1],order:i,states:[]};t.currentCategory.quests.push(r),t.currentQuest=r}parseQuestStateRow(e,t){let s=this.requireDeclared(t,!0,!0);if(s.error)return s;this.undeclare(t,!1,!1,!0);let n=parseInt(e[0]);if(n<1||n>5)return{row:t.rowNumber,column:0,error:"Invalid quest state type: "+n};if(!e[1]?.trim())return{row:t.rowNumber,column:1,error:"Quest state description is empty."};let i=this.conditionParser.parse(e[2],t.mappings);if(!i)return{row:t.rowNumber,column:2,error:"Quest state condition is empty or malformed."};if(i.error)return i;let r={state:n,description:e[1],condition:i,tasks:[]};t.currentQuest.states.push(r),t.currentQuestState=r}parseTaskRow(e,t){let s=this.requireDeclared(t,!0,!0,!0);if(s.error)return s;if(!e[1]?.trim())return{row:t.rowNumber,column:1,error:"Task description is empty."};let n=this.conditionParser.parse(e[2],t.mappings);if(!n)return{row:t.rowNumber,column:2,error:"Task completed condition is empty or malformed."};let i={description:e[1],completed:n},r=this.conditionParser.parse(e[3],t.mappings);r&&(i.visible=r),t.currentQuestState.tasks.push(i)}requireClosed(e,t,s){return t&&e.currentCategory&&0==e.currentCategory.quests.length?{row:e.rowNumber,column:0,error:"Category did not declare any quests."}:!s||!e.currentQuest||0!=e.currentQuest.states.length||{row:e.rowNumber,column:0,error:"Quest did not declare any states."}}requireDeclared(e,t,s,n){return t&&!e.currentCategory?{row:e.rowNumber,column:0,error:"A category has not been declared."}:s&&!e.currentQuest?{row:e.rowNumber,column:0,error:"A quest has not been declared."}:!(n&&!e.currentQuestState)||{row:e.rowNumber,column:0,error:"A quest state has not been declared."}}undeclare(e,t,s,n){return t&&(e.currentCategory=null),s&&(e.currentQuest=null),n&&(e.currentQuestState=null),!0}}class g{static singleInstance=null;static instance(){return this.singleInstance||(this.singleInstance=new g),this.singleInstance}static TabData={Tab:{Home:1,Settings:2,Help:3},ID:{HomeTab:"flq-to-home",HomeBody:"flq-home",SettingsTab:"flq-to-settings",SettingsBody:"flq-settings",HelpTab:"flq-to-help",HelpBody:"flq-help"},Class:{Tab:"flq-tab",Selected:"flq-tab-selected",Clickable:"flq-tab-clickable"}};static CategoryState={Show:0,Collapsed:1,Hide:2};constructor(){this.qualities=s.instance(),this.settings=r.instance(),this.renderer=new o,this.quests=new u,this.questsImporter=new m}attachEvents(){let e=document.getElementById("flq-modal");document.getElementById("flq-close").onclick=function(){e.style.display="none",g.instance().qualities.releaseSpoof()},window.onclick=function(t){t.target==e&&(e.style.display="none",g.instance().qualities.releaseSpoof())},this.attachTabEvents(),this.attachSettingEvents(),this.attachImportEvents(),this.attachHelpEvents()}attachTabEvents(){document.getElementById(g.TabData.ID.HomeTab).onclick=async function(){await g.instance().renderQuests(),await g.instance().renderSettings(),g.instance().selectTab(g.TabData.Tab.Home)},document.getElementById(g.TabData.ID.SettingsTab).onclick=function(){g.instance().selectTab(g.TabData.Tab.Settings)},document.getElementById(g.TabData.ID.HelpTab).onclick=function(){g.instance().selectTab(g.TabData.Tab.Help)}}attachSettingEvents(){this.settingsElems={hideNotStarted:document.getElementById("flq-hidenotstarted"),questSourceNone:document.getElementById("flq-qsource-none"),questSourceLocal:document.getElementById("flq-qsource-local"),questSourceGithub:document.getElementById("flq-qsource-github"),questSourceCustom:document.getElementById("flq-qsource-custom"),questSourceAddress:document.getElementById("flq-qsource-address"),enableImport:document.getElementById("flq-enable-quest-import"),importPanel:document.getElementById("flq-quest-import-panel"),importState:document.getElementById("flq-import-state"),categorySettings:document.getElementById("flq-cat-settings")},this.settingsElems.hideNotStarted.addEventListener("change",e=>{this.renderingSettings||this.settings.setHideNotStarted(e.currentTarget.checked)}),this.settingsElems.questSourceNone.addEventListener("change",e=>{!this.renderingSettings&&e.currentTarget.checked&&(this.settings.setQuestsSourceType(0),this.quests.clear()),this.updateSettingEnabledStates()}),this.settingsElems.questSourceLocal.addEventListener("change",e=>{!this.renderingSettings&&e.currentTarget.checked&&(this.settings.setQuestsSourceType(1),this.quests.clear()),this.updateSettingEnabledStates()}),this.settingsElems.questSourceGithub.addEventListener("change",e=>{!this.renderingSettings&&e.currentTarget.checked&&(this.settings.setQuestsSourceType(2),this.quests.clear()),this.updateSettingEnabledStates()}),this.settingsElems.questSourceCustom.addEventListener("change",e=>{!this.renderingSettings&&e.currentTarget.checked&&(this.settings.setQuestsSourceType(3),this.quests.clear()),this.updateSettingEnabledStates()}),this.settingsElems.questSourceAddress.addEventListener("blur",e=>{this.renderingSettings||e.currentTarget.value==this.settings.getCustomQuestsSource()||(this.settings.setCustomQuestsSource(e.currentTarget.value),this.quests.clear())}),this.settingsElems.enableImport.addEventListener("change",async e=>{this.renderingSettings||this.settings.setEnableImportedQuests(e.currentTarget.checked),this.quests.clearImported(),await this.renderSettings()})}attachImportEvents(){document.getElementById("flq-clear-imported-button").onclick=async function(){confirm("Are you sure you want to clear your imported quests?")&&g.instance().settings.getImportedQuests()&&(g.instance().settings.setImportedQuests(""),g.instance().quests.clearImported(),await g.instance().renderSettings())},document.getElementById("flq-import-quests-button").onclick=function(){g.instance().importQuests()}}attachHelpEvents(){document.getElementById("flq-export-button").onclick=function(){g.instance().exportQualities()},document.getElementById("flq-spoof-button").onclick=function(){g.instance().importQualities()}}async importQualities(){try{let e=await this.openFileDialog(!1);if(!e||0==e.length)return;let t=await this.readFile(e[0]),s=this.qualities.spoofFromCSV(t);alert(`Spoofed ${s} Qualities.`)}catch(e){i.error(e),alert(`IMPORT THREW AN ERROR\n\n${e}`)}}async importQuests(){try{let e=await this.openFileDialog(!0);if(e&&e.length>0){let t;for(let s=0;s<e.length;s++){let n=await this.readFile(e[s]),i=this.questsImporter.parse(n);if(i.error){if(i.row){let t=(10+i.column).toString(36).toUpperCase();alert(`IMPORT FAILED\nFile: ${e[s].name}\nCell: ${t}${i.row}\n\n${i.error}`)}else alert(`IMPORT FAILED\nFile :${e[s].name}\n\n${i.error}`);return}let r=this.quests.validator.validate(i,!0);if(!r.valid)return void alert(`VALIDATION FAILED\nFile :${e[s].name}\n\n${r.reason}`);t?this.mergeQuests(t,i):t=i}if(!t||0==t.categories.length)return void alert("IMPORT FAILED\n\nNo quests found.");let s=await this.quests.getCategories(),n=[],i=[];t.categories.forEach(e=>{s.find(t=>t.id==e.id)?n.push(e.id):i.push(e.id)});let r=this.settings.getImportedQuests();if(r){let e=JSON.parse(r);t=this.mergeQuests(e,t)}this.settings.setImportedQuests(JSON.stringify(t)),this.quests.clearImported();let a="";n.length>0&&(a+=`\n\nNew Overrides\n    ${n.join("\n    ")}`),i.length>0&&(a+=`\n\nNew Additions\n    ${i.join("\n    ")}`),await this.renderSettings(),alert(`IMPORT SUCCESSFUL\nImported ${n.length+i.length} categories${a}`)}}catch(e){i.error(e),alert(`IMPORT THREW AN ERROR\n\n${e}`)}}openFileDialog(e){return new Promise(t=>{let s=document.createElement("input");s.setAttribute("type","file"),s.setAttribute("accept","text/csv,.csv"),e&&s.setAttribute("multiple",""),s.addEventListener("change",e=>{t(e.target.files)}),s.addEventListener("cancel",e=>{t()}),s.click()})}readFile(e){return new Promise((t,s)=>{let n=new FileReader;n.onload=()=>{t(n.result)},n.onerror=()=>{s(new Error(`An error occurred reading file: ${e.name}`))},n.readAsText(e)})}mergeQuests(e,t){t.categories.forEach(t=>{let s=e.categories.findIndex(e=>e.id==t.id);s>=0?e.categories[s]=t:e.categories.push(t)})}selectTab(e){if(this.currentTab==e)return;const t=[document.getElementById(g.TabData.ID.HomeTab),document.getElementById(g.TabData.ID.SettingsTab),document.getElementById(g.TabData.ID.HelpTab)],s=[document.getElementById(g.TabData.ID.HomeBody),document.getElementById(g.TabData.ID.SettingsBody),document.getElementById(g.TabData.ID.HelpBody)];for(let n=0;n<t.length;n++)n==e-1?(t[n].classList.remove(g.TabData.Class.Clickable),t[n].classList.add(g.TabData.Class.Selected),s[n].style.display="block"):(t[n].classList.remove(g.TabData.Class.Selected),t[n].classList.add(g.TabData.Class.Clickable),s[n].style.display="none");this.currentTab=e}async show(){this.selectTab(g.TabData.Tab.Home);const e=document.getElementById("flq-modal");await this.renderQuests(),await this.renderSettings(),e&&(e.style.display="block")}async renderQuests(){const e=document.getElementById("flq-home");this.clearChildren(e);try{let t=await this.quests.renderQuests(),s=[],n=this.settings.getHideNotStarted();t.forEach(e=>{let t=this.settings.getCategoryState(e.id);t!=g.CategoryState.Hide&&(n&&!e.quests.find(e=>e.state!=QuestStates.NotStart&&e.state!=QuestStates.HiddenStatus)||s.push(this.renderer.makeCategoryElement(e,t==g.CategoryState.Collapsed)))}),s.forEach(t=>{e.appendChild(t)})}catch(t){e.innerHTML='\n                <div id="flq-error-title">Error Rendering Quests</div>\n                <div id="flq-error-message"></div>\n                <div id="flq-error-trace"></div>\n            ';let s=document.getElementById("flq-error-message"),n=document.getElementById("flq-error-trace");s.innerText=t.message,n.innerText=t.stack}}async renderSettings(){this.renderingSettings=!0;try{switch(this.settingsElems.hideNotStarted.checked=this.settings.getHideNotStarted(),this.settingsElems.enableImport.checked=this.settings.getEnableImportedQuests(),this.settingsElems.questSourceAddress.value=this.settings.getCustomQuestsSource()??"",this.settings.getQuestsSourceType()){case 0:this.settingsElems.questSourceNone.checked=!0;break;case 2:this.settingsElems.questSourceGithub.checked=!0;break;case 3:this.settingsElems.questSourceCustom.checked=!0;break;default:this.settingsElems.questSourceLocal.checked=!0}this.updateSettingEnabledStates(),this.clearChildren(this.settingsElems.categorySettings);let e=await this.quests.getCategories(),t=[],s=[];for(const n in e){let i=e[n];i.isImport&&(i.isOverride?s.push(i):t.push(i));let r=document.createElement("input");r.setAttribute("type","checkbox"),r.setAttribute("id",`hideCat${n}`),r.setAttribute("name",`hideCat${n}`),r.checked=this.settings.getCategoryState(i.id)==g.CategoryState.Hide,r.addEventListener("change",e=>{this.settings.setCategoryState(i.id,e.currentTarget.checked?g.CategoryState.Hide:g.CategoryState.Show)});let o=document.createElement("label");o.setAttribute("for",`hideCat${n}`),o.innerHTML=`Hide ${a.sanitizeAndFormat(i.title)}`,this.settingsElems.categorySettings.appendChild(r),this.settingsElems.categorySettings.appendChild(document.createTextNode(" ")),this.settingsElems.categorySettings.appendChild(o),this.settingsElems.categorySettings.appendChild(document.createElement("br"))}let n="";s.length>0&&(n+="Overridden Categories:\n",n+=s.map(e=>e.title==e.originalTitle?`    ${a.sanitizeAndFormat(e.title)}`:`    ${a.sanitizeAndFormat(e.originalTitle)} -> ${a.sanitizeAndFormat(e.title)}`).join("\n")),t.length>0&&(n&&(n+="\n\n"),n+="Imported Categories:\n",n+=t.map(e=>`    ${a.sanitizeAndFormat(e.title)}`).join("\n")),n||(n="No Imports"),this.settingsElems.importState.innerText=n}catch(e){i.error(e),this.clearChildren(this.settingsElems.categorySettings)}finally{this.renderingSettings=!1}}updateSettingEnabledStates(){this.settingsElems.questSourceAddress.disabled=!this.settingsElems.questSourceCustom.checked,this.settingsElems.importPanel.style.display=this.settingsElems.enableImport.checked?"block":"none"}clearChildren(e){for(;e.firstChild;)e.removeChild(e.lastChild)}exportQualities(){const e=this.qualities.exportToCSV();this.downloadFile("fl-character-qualties.csv",e)}downloadFile(e,t){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),s.setAttribute("download",e),s.style.display="none",document.body.appendChild(s),s.click(),document.removeChild(s)}}class p{static rawModal='\n        <div id="flq-modal" class="flq-modal-wrapper">\n            <div class="flq-modal-box">\n                <div class="flq-outline">\n                    <span id="flq-close">&#10006;</span>\n                    <div class="flq-title">\n                        Quests Journal\n                    </div>\n                    <div class="flq-subtitle-links">\n                        <span id="flq-to-home" class="flq-tab">Home</span> | \n                        <span id="flq-to-settings" class="flq-tab">Settings</span> | \n                        <span id="flq-to-help" class="flq-tab">Help</span>\n                    </div>\n                    <hr/>\n                    <div class="flq-body">\n                        <div id="flq-home">\n                        </div>\n                        <div id="flq-settings">\n                            <div class="flq-settings-group">\n                                <div class="flq-settings-title">General</div>\n                                <div class="flq-settings-body">\n                                    <input type="checkbox" id="flq-hidenotstarted" name="flq-hidenotstarted">\n                                    <label for="flq-hidenotstarted">Hide quests that have not been started</label>\n                                </div>\n                            </div>\n                            <div class="flq-settings-group">\n                                <div class="flq-settings-title">Categories</div>\n                                <div id="flq-cat-settings" class="flq-settings-body">\n                                </div>\n                            </div>\n                            <div class="flq-settings-group">\n                                <div class="flq-settings-title">Quests Source</div>\n                                <div class="flq-settings-body">\n                                    Where should the base quest list be pulled from?\n                                    <div class="flq-settings-body">\n                                        <input type="radio" id="flq-qsource-none" name="flq-qsource">\n                                        <label for="flq-qsource-none">Imported Only</label><br>\n                                        <input type="radio" id="flq-qsource-local" name="flq-qsource">\n                                        <label for="flq-qsource-local">Built In</label><br>\n                                        <input type="radio" id="flq-qsource-github" name="flq-qsource">\n                                        <label for="flq-qsource-github">GitHub</label><br>\n                                        <input type="radio" id="flq-qsource-custom" name="flq-qsource">\n                                        <label for="flq-qsource-custom">Custom:</label>\n                                        <div class="flq-settings-body" style="margin-right:40px;">\n                                            <input type="text" id="flq-qsource-address" disabled>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="flq-settings-group">\n                                <div class="flq-settings-title">Imported Quests</div>\n                                <div class="flq-settings-body">\n                                    <input type="checkbox" id="flq-enable-quest-import" name="flq-enable-quest-import">\n                                    <label for="flq-enable-quest-import">Enable quest importing</label><br>\n                                    <div class="flq-settings-body" id="flq-quest-import-panel">\n                                        <div>\n                                        <span id="flq-import-quests-button" class="button button--primary button--no-margin">Import</span>\n                                        <span id="flq-clear-imported-button" class="button button--primary button--no-margin">Clear</span>\n                                        </div>\n                                        <div id="flq-import-state">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div id="flq-help">\n                            <p>Some troubleshooting advice.</p>\n                            <div style="text-align: center;">\n                                <span id="flq-export-button" class="button button--primary button--no-margin">Export My Qualities</span>\n                            </div>\n                            <div style="text-align: center;">\n                                <span id="flq-spoof-button" class="button button--primary button--no-margin">Spoof My Qualities</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        ';static insertModalElements(){let e=document.createElement("div");e.innerHTML=p.rawModal.trim(),document.body.appendChild(e.firstChild),g.instance().attachEvents()}static modalCheckForDOM(){document.body&&document.head?p.insertModalElements():requestIdleCallback(p.modalCheckForDOM)}static injectModalHtml(){requestIdleCallback(p.modalCheckForDOM)}}(class{static interceptorScript='\n        (function () {\n            console.debug("[FL Quests] Executing injected code...");\n            function parseResponse(response) {\n                if (this.readyState !== 4) {\n                    return;\n                }\n\n                if(response.currentTarget.responseURL.includes("/api/character/myself")){\n                    var messengerElem = document.getElementById(\'__questsInterceptedMyself\');\n                    messengerElem.innerText = this.response;\n                }\n\n                if(response.currentTarget.responseURL.includes("/api/storylet/choosebranch")){\n                    var messengerElem = document.getElementById(\'__questsInterceptedBranch\');\n                    messengerElem.innerText = this.response;\n                }\n\n                if(response.currentTarget.responseURL.includes("/api/agents/branch")){\n                    var messengerElem = document.getElementById(\'__questsInterceptedBranch\');\n                    messengerElem.innerText = this.response;\n                }\n\n                if(response.currentTarget.responseURL.includes("/api/exchange/sell")){\n                    var messengerElem = document.getElementById(\'__questsInterceptedExchange\');\n                    messengerElem.innerText = this.response;\n                }\n\n                if(response.currentTarget.responseURL.includes("/api/exchange/buy")){\n                    var messengerElem = document.getElementById(\'__questsInterceptedExchange\');\n                    messengerElem.innerText = this.response;\n                }\n            }\n\n            function openBypass(original_function) {\n                return function (method, url, async) {\n                    this.addEventListener("readystatechange", parseResponse);\n                    return original_function.apply(this, arguments);\n                };\n            }\n\n            XMLHttpRequest.prototype.open = openBypass(XMLHttpRequest.prototype.open);\n        }())\n        ';static injectInterceptors(){let e=document.createElement("script");e.type="text/javascript",e.innerHTML=this.interceptorScript,e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e),this.makeInterceptElement("__questsInterceptedMyself",function(){var e=document.getElementById("__questsInterceptedMyself");let t=JSON.parse(e.innerText);s.instance().onMyself(t)}),this.makeInterceptElement("__questsInterceptedBranch",function(){var e=document.getElementById("__questsInterceptedBranch");let t=JSON.parse(e.innerText);s.instance().onBranch(t)}),this.makeInterceptElement("__questsInterceptedExchange",function(){var e=document.getElementById("__questsInterceptedExchange");let t=JSON.parse(e.innerText);s.instance().onExchange(t)}),console.log("[FL Quests] Request interception installed")}static makeInterceptElement(e,t){const s=window.MutationObserver||window.WebKitMutationObserver;let n=document.createElement("div");n.id=e,n.style.height=0,n.style.overflow="hidden",document.documentElement.appendChild(n),n=document.getElementById(e),new s(t).observe(n,{subtree:!0,childList:!0,characterData:!0})}}).injectInterceptors(),n.injectStyles(),p.injectModalHtml(),class{static addQuestsButton(e){let t=document.createTextNode(" ");e.prepend(t);let s=document.createElement("span");s.id="quests-button",s.className="button button--primary button--no-margin",s.innerText="Open Quests",s.onclick=()=>{g.instance().show()},e.prepend(s)}static startButtonObserver(){new MutationObserver(e=>{if(document.querySelector("#quests-button"))return;let t=document.querySelector(".myself-profile__view-and-set-private div .button");t&&this.addQuestsButton(t.parentElement)}).observe(document,{childList:!0,subtree:!0})}}.startButtonObserver()})();